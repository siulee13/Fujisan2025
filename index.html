import React, { useState, useRef } from 'react';
import { Map, Navigation, Sun, Cloud, CloudRain, Coffee, Camera, Utensils, Car, BedDouble, ArrowRight, Eye, Plus, GripVertical, X, Save, ExternalLink, Clock, Sparkles, MessageSquare, Loader } from 'lucide-react';

const FujiTripApp = () => {
  // -------------------------------------------------------------------------
  // Gemini API è¨­å®š
  // -------------------------------------------------------------------------
  const apiKey = ""; // åŸ·è¡Œç’°å¢ƒæœƒåœ¨é‹è¡Œæ™‚æä¾›é‡‘é‘°ï¼Œç„¡éœ€æ‰‹å‹•å¡«å¯«

  // -------------------------------------------------------------------------
  // 1. åˆå§‹åŒ–è³‡æ–™èˆ‡ç‹€æ…‹
  // -------------------------------------------------------------------------
  
  // åˆå§‹è¡Œç¨‹è³‡æ–™
  const initialItinerary = [
    {
      day: "Day 0",
      date: "12/5 (äº”)",
      title: "å‡ºç™¼èˆ‡æŠµé”",
      color: "bg-orange-100",
      items: [
        {
          id: 'd0-1',
          time: '20:20',
          title: 'é¦™æ¸¯èµ·é£›',
          desc: 'UO628 HKG -> HND',
          location: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´',
          mapCode: '-',
          googleQuery: 'Hong Kong International Airport',
          iconType: 'Navigation'
        },
        {
          id: 'd0-2',
          time: '00:32',
          title: 'æŠµé”ç¾½ç”° & å…¥ä½',
          desc: 'T3 ç›´çµï¼Œé ˜è¡Œæå¾Œç›´æ¥ç¡è¦º',
          location: 'çš‡å®¶å…¬åœ’é…’åº— æ±äº¬ç¾½ç”°',
          mapCode: '167 327 714*32',
          googleQuery: 'The Royal Park Hotel Tokyo Haneda Airport Terminal 3',
          iconType: 'BedDouble',
          // æ©Ÿå ´å…§ç§»å‹•ï¼Œä¸é¡¯ç¤ºè¡Œè»Šæ™‚é–“
        }
      ]
    },
    {
      day: "Day 1",
      date: "12/6 (å…­)",
      title: "æ²³å£æ¹–ç¶“å…¸å·¡ç¦®",
      color: "bg-blue-100",
      items: [
        {
          id: 'd1-1',
          time: '09:30',
          title: 'ç¾½ç”°å–è»Šå‡ºç™¼',
          desc: 'è¨˜å¾—æª¢æŸ¥ ETC å¡èˆ‡é›ªèƒã€‚',
          location: 'ç¾½ç”°æ©Ÿå ´ç§Ÿè»Šé»',
          mapCode: '167 327 714*32',
          googleQuery: 'Haneda Airport Rental Car',
          iconType: 'Car'
        },
        {
          id: 'd1-2',
          time: '12:30',
          title: 'åˆé¤ï¼šHoutou Fudo',
          desc: 'å¿…åƒé›²æœµé€ å‹é¤ºé£¥éºµ (æ±æ‹è·¯åº—)',
          location: 'ã»ã†ã¨ã†ä¸å‹• æ±æ‹è·¯åº—',
          mapCode: '161 240 502*12',
          googleQuery: 'Houtou Fudo Higashikoiji',
          iconType: 'Utensils',
          travelTime: 'ç´„ 1å°æ™‚50åˆ†' // ç¾½ç”° -> æ²³å£æ¹–
        },
        {
          id: 'd1-3',
          time: '14:00',
          title: 'å¤§çŸ³å…¬åœ’',
          desc: 'æ²³å£æ¹–ç•”çœ‹å¯Œå£«å±±å…¨æ™¯ï¼Œçµ•ç¾ï¼',
          location: 'å¤§çŸ³å…¬åœ’',
          mapCode: '161 303 629*28',
          googleQuery: 'Oishi Park Yamanashi',
          iconType: 'Camera',
          travelTime: 'ç´„ 20åˆ†' // æ±æ‹è·¯åº— -> å¤§çŸ³å…¬åœ’
        },
        {
          id: 'd1-4',
          time: '15:30',
          title: 'ç´…è‘‰è¿´å»Š',
          desc: 'å°‹æ‰¾æœ€å¾Œçš„ç´…è‘‰åœ°æ¯¯ (ä¹…ä¿ç”°ä¸€ç«¹ç¾è¡“é¤¨æ—)',
          location: 'å¯Œå£«æ²³å£æ¹–ç´…è‘‰è¿´å»Š',
          mapCode: '161 303 346*55',
          googleQuery: 'Momiji Corridor Kawaguchiko',
          iconType: 'Camera',
          travelTime: 'ç´„ 5åˆ†' // å¤§çŸ³å…¬åœ’ -> ç´…è‘‰è¿´å»Š (å¾ˆè¿‘)
        },
        {
          id: 'd1-5',
          time: '16:30',
          title: 'å…¥ä½ La Vista',
          desc: 'äº«å—ç§äººé¢¨å‘‚èˆ‡å…è²»å®µå¤œæ‹‰éºµ',
          location: 'La Vista Fuji Kawaguchiko',
          mapCode: '161 301 224*88',
          googleQuery: 'La Vista Fuji Kawaguchiko',
          iconType: 'BedDouble',
          travelTime: 'ç´„ 8åˆ†' // ç´…è‘‰è¿´å»Š -> La Vista
        }
      ]
    },
    {
      day: "Day 2",
      date: "12/7 (æ—¥)",
      title: "çµ•æ™¯ç¥ç¤¾èˆ‡é‘½çŸ³å¯Œå£«",
      color: "bg-yellow-100",
      items: [
        {
          id: 'd2-1',
          time: '09:00',
          title: 'æ–°å€‰å±±æ·ºé–“å…¬åœ’',
          desc: 'çˆ¬æ¨“æ¢¯ï¼äº”é‡å¡” + å¯Œå£«å±±ç¶“å…¸ç…§',
          location: 'æ–°å€‰å±±æ·ºé–“å…¬åœ’',
          mapCode: '161 244 562*52',
          googleQuery: 'Chureito Pagoda',
          iconType: 'Camera',
          travelTime: 'ç´„ 25åˆ†' // La Vista -> æ–°å€‰å±± (è¦éæ©‹èˆ‡å¸‚å€)
        },
        {
          id: 'd2-2',
          time: '12:30',
          title: 'åˆé¤ï¼šå±±éº“åœ’',
          desc: 'é«”é©—åœçˆè£ç‚­ç«ç‡’çƒ¤',
          location: 'å±±éº“åœ’ (Sanrokuen)',
          mapCode: '161 214 058*60',
          googleQuery: 'Sanrokuen Kawaguchiko',
          iconType: 'Utensils',
          travelTime: 'ç´„ 15åˆ†' // æ–°å€‰å±± -> å±±éº“åœ’
        },
        {
          id: 'd2-3',
          time: '15:30',
          title: 'å±±ä¸­æ¹–èŠ±ä¹‹éƒ½å…¬åœ’',
          desc: 'å†¬å­£é»ç‡ˆ + æ©Ÿæœƒçœ‹é‘½çŸ³å¯Œå£«',
          location: 'å±±ä¸­æ¹–èŠ±ä¹‹éƒ½å…¬åœ’',
          mapCode: '161 046 805*44',
          googleQuery: 'Yamanakako Hananomiyako Park',
          iconType: 'Camera',
          travelTime: 'ç´„ 25åˆ†' // å±±éº“åœ’ -> å±±ä¸­æ¹–
        },
        {
          id: 'd2-4',
          time: '18:00',
          title: 'å…¥ä½ New Century',
          desc: 'æˆ¿é–“ç›´æ¥çœ‹æ¹–é¢é€†å¯Œå£«',
          location: 'Hotel New Century',
          mapCode: '161 302 188*41',
          googleQuery: 'Hotel New Century Kawaguchiko',
          iconType: 'BedDouble',
          travelTime: 'ç´„ 25åˆ†' // å±±ä¸­æ¹– -> æ²³å£æ¹–é£¯åº—å€
        }
      ]
    },
    {
      day: "Day 3",
      date: "12/8 (ä¸€)",
      title: "æœéœ§é«˜åŸèˆ‡å›ç¨‹",
      color: "bg-green-100",
      items: [
        {
          id: 'd3-1',
          time: '09:30',
          title: 'å‡ºç™¼å¾€è¥¿éº“',
          desc: 'é›¢é–‹æ²³å£æ¹–ï¼Œæ²¿åœ‹é“139è™Ÿå¾€è¥¿',
          location: 'å¾€æœéœ§é«˜åŸæ–¹å‘',
          mapCode: '-',
          googleQuery: 'National Route 139',
          iconType: 'Car'
        },
        {
          id: 'd3-2',
          time: '10:30',
          title: 'æœéœ§é«˜åŸ (é¦¬é£¼é‡ç‰§å ´)',
          desc: 'ç„¡é®æ“‹çš„å·¨å¤§å¯Œå£«å±±ï¼ç›ªé¦éŸ†æ‹ç…§ã€å–ç‰›å¥¶',
          location: 'é¦¬é£¼é‡ç‰§å ´ (Makaino Farm)',
          mapCode: '72 233 426*77',
          googleQuery: 'Makaino Farm',
          iconType: 'Camera',
          travelTime: 'ç´„ 45åˆ†' // æ²³å£æ¹– -> æœéœ§é«˜åŸ
        },
        {
          id: 'd3-3',
          time: '12:00',
          title: 'åˆé¤ï¼šé“ä¹‹ç«™ æœéœ§',
          desc: 'ç•¶ç¬¬ç¾é£Ÿã€ç‰›å¥¶éœœæ·‡æ·‹',
          location: 'Roadside Station Asagiri',
          mapCode: '72 263 777*25',
          googleQuery: 'Roadside Station Asagiri',
          iconType: 'Utensils',
          travelTime: 'ç´„ 5åˆ†' // ç‰§å ´ -> é“ä¹‹ç«™ (å¾ˆè¿‘)
        },
        {
          id: 'd3-4',
          time: '14:30',
          title: 'é…’é…’äº• Outlet',
          desc: 'æœ€å¾Œè¡åˆºï¼(ç¶“æ–°æ±å/åœˆå¤®é“å‰å¾€)',
          location: 'Shisui Premium Outlets',
          mapCode: '27 573 846*77',
          googleQuery: 'Shisui Premium Outlets',
          iconType: 'Coffee',
          travelTime: 'ç´„ 2å°æ™‚45åˆ†' // æœéœ§ -> é…’é…’äº• (é•·é€”)
        },
        {
          id: 'd3-5',
          time: '17:30',
          title: 'æˆç”°æ©Ÿå ´é‚„è»Š',
          desc: 'åŠ æ»¿æ²¹ï¼Œæª¢æŸ¥ç‰©å“',
          location: 'æˆç”°æ©Ÿå ´é™„è¿‘ç§Ÿè»Š',
          mapCode: '137 646 088*55',
          googleQuery: 'Narita Airport Rental Car Return',
          iconType: 'Car',
          travelTime: 'ç´„ 15åˆ†' // é…’é…’äº• -> æˆç”°
        },
        {
          id: 'd3-6',
          time: '20:05',
          title: 'é£›æ©Ÿèµ·é£›',
          desc: 'UO651 NRT -> HKG',
          location: 'æˆç”°åœ‹éš›æ©Ÿå ´',
          mapCode: '-',
          googleQuery: 'Narita International Airport',
          iconType: 'Navigation'
        }
      ]
    }
  ];

  // å¤©æ°£æ•¸æ“š - è³‡æ–™ä¾†æº: Fuji-san.info
  const weatherData = {
    '12/5': { 
      icon: <Cloud className="w-6 h-6 text-gray-400" />, 
      temp: '8Â°C', 
      desc: 'å¤§è‡´å¤šé›²', 
      visibility: '9/10',
      statusColor: 'text-blue-600'
    },
    '12/6': { 
      icon: <Sun className="w-6 h-6 text-orange-500" />, 
      temp: '-2~9Â°C', 
      desc: 'æ™´æ™‚å¤šé›²', 
      visibility: '10/10',
      statusColor: 'text-orange-600'
    },
    '12/7': { 
      icon: <Sun className="w-6 h-6 text-orange-500" />, 
      temp: '-3~8Â°C', 
      desc: 'è¶…ç´šæ™´æœ—', 
      visibility: '10/10',
      statusColor: 'text-orange-600'
    },
    '12/8': { 
      icon: <Sun className="w-6 h-6 text-orange-500" />, 
      temp: '-4~10Â°C', 
      desc: 'è¬é‡Œç„¡é›²', 
      visibility: '10/10',
      statusColor: 'text-orange-600'
    },
  };

  // Icon æ˜ å°„è¡¨
  const iconMap = {
    'Navigation': <Navigation className="w-5 h-5" />,
    'BedDouble': <BedDouble className="w-5 h-5" />,
    'Car': <Car className="w-5 h-5" />,
    'Utensils': <Utensils className="w-5 h-5" />,
    'Camera': <Camera className="w-5 h-5" />,
    'Coffee': <Coffee className="w-5 h-5" />,
    'Map': <Map className="w-5 h-5" />
  };

  // State
  const [itinerary, setItinerary] = useState(initialItinerary);
  const [activeId, setActiveId] = useState('d1-1');
  const [showMapCode, setShowMapCode] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [targetDayIndex, setTargetDayIndex] = useState(0);
  const [newItemData, setNewItemData] = useState({
    time: '', title: '', desc: '', location: '', mapCode: '', iconType: 'Camera'
  });
  
  // AI ç›¸é—œ State
  const [isAIModalOpen, setIsAIModalOpen] = useState(false);
  const [aiResponse, setAiResponse] = useState('');
  const [aiLoading, setAiLoading] = useState(false);
  const [aiAction, setAiAction] = useState(null);

  // æ‹–æ›³é‚è¼¯ refs
  const dragItem = useRef();
  const dragOverItem = useRef();

  // Handlers (Drag, Drop, Modal)
  const handleDragStart = (e, dayIndex, itemIndex) => {
    dragItem.current = { dayIndex, itemIndex };
    e.dataTransfer.effectAllowed = "move";
    setTimeout(() => { e.target.classList.add('opacity-50'); }, 0);
  };
  const handleDragEnter = (e, dayIndex, itemIndex) => {
    dragOverItem.current = { dayIndex, itemIndex };
    e.preventDefault();
  };
  const handleDragOver = (e) => { e.preventDefault(); };
  const handleDragEnd = (e) => {
     e.target.classList.remove('opacity-50');
     dragItem.current = null;
     dragOverItem.current = null;
  };
  const handleDrop = () => {
    if (!dragItem.current || !dragOverItem.current) return;
    const sourceDayIdx = dragItem.current.dayIndex;
    const sourceItemIdx = dragItem.current.itemIndex;
    const destDayIdx = dragOverItem.current.dayIndex;
    const destItemIdx = dragOverItem.current.itemIndex;

    let newItinerary = [...itinerary];
    const dragItemContent = newItinerary[sourceDayIdx].items[sourceItemIdx];
    newItinerary[sourceDayIdx].items.splice(sourceItemIdx, 1);
    newItinerary[destDayIdx].items.splice(destItemIdx, 0, dragItemContent);
    setItinerary(newItinerary);
  };

  const openAddModal = (dayIndex) => {
    setTargetDayIndex(dayIndex);
    setNewItemData({ time: '12:00', title: '', desc: '', location: '', mapCode: '', iconType: 'Camera' });
    setIsModalOpen(true);
  };
  const handleAddItem = () => {
    if (!newItemData.title) return;
    const newItinerary = [...itinerary];
    const newItem = { id: `new-${Date.now()}`, ...newItemData, googleQuery: newItemData.location };
    newItinerary[targetDayIndex].items.push(newItem);
    setItinerary(newItinerary);
    setIsModalOpen(false);
  };
  const getCurrentItem = () => {
    for (const day of itinerary) {
      const found = day.items.find(item => item.id === activeId);
      if (found) return found;
    }
    if (itinerary[0].items.length > 0) return itinerary[0].items[0];
    return { location: 'è«‹é¸æ“‡è¡Œç¨‹', mapCode: '-', googleQuery: '' };
  };

  const currentItem = getCurrentItem();

  // -------------------------------------------------------------------------
  // Gemini AI å‘¼å«é‚è¼¯
  // -------------------------------------------------------------------------
  const callGemini = async (type) => {
    setAiLoading(true);
    setAiAction(type);
    setAiResponse('');
    
    // æ§‹å»ºæç¤ºè© (Prompt)
    let prompt = `ä½ æ˜¯ä¸€ä½ç†Ÿæ‚‰æ—¥æœ¬å¯Œå£«å±±åœ°å€çš„ç¹é«”ä¸­æ–‡(é¦™æ¸¯é¢¨æ ¼)å°éŠã€‚
    ä½¿ç”¨è€…ç›®å‰ä½æ–¼ï¼š${currentItem.location} (${currentItem.title})ã€‚
    è«‹ç°¡çŸ­ã€æœ‰è¶£åœ°å›ç­”ä»¥ä¸‹å•é¡Œï¼š`;

    switch (type) {
      case 'food':
        prompt += ` è«‹æ¨è–¦ 2-3 é–“æ­¤åœ°é»é™„è¿‘çš„å¿…åƒç¾é£Ÿæˆ–é¤å»³ï¼Œä¸¦èªªæ˜ç‰¹è‰²ã€‚`;
        break;
      case 'photo':
        prompt += ` è«‹æä¾›æ­¤åœ°é»çš„æœ€ä½³æ”å½±å»ºè­°ï¼ˆä¾‹å¦‚ï¼šæ‹æ”è§’åº¦ã€æœ€ä½³æ™‚é–“ã€æ˜¯å¦èƒ½çœ‹åˆ°é€†å¯Œå£«æˆ–é‘½çŸ³å¯Œå£«ï¼‰ã€‚`;
        break;
      case 'info':
        prompt += ` è«‹å‘Šè¨´æˆ‘é—œæ–¼æ­¤åœ°é»çš„ä¸€å€‹å†·çŸ¥è­˜ã€æ­·å²æ•…äº‹æˆ–éš±è—ç©æ³•ã€‚`;
        break;
      default:
        prompt += ` çµ¦æˆ‘ä¸€äº›é—œæ–¼é€™å€‹åœ°æ–¹çš„å¯¦ç”¨æ—…éŠå»ºè­°ã€‚`;
    }

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
          }),
        }
      );

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼ŒGemini æš«æ™‚ç„¡æ³•é€£ç·šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      setAiResponse(text);
    } catch (error) {
      console.error("Gemini API Error:", error);
      setAiResponse("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
    } finally {
      setAiLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-orange-50 font-sans pb-44 max-w-md mx-auto shadow-2xl overflow-hidden relative">
      {/* é ‚éƒ¨æ¨™é¡Œ */}
      <div className="bg-white p-4 rounded-b-3xl shadow-sm sticky top-0 z-10">
        <div className="flex justify-between items-start mb-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-800 tracking-wider" style={{ fontFamily: '"Kosugi Maru", sans-serif' }}>
              å¯Œå£«å±±è¿½æ¥“ä¹‹æ—… ğŸ
            </h1>
            <div className="text-xs text-gray-400">12/5 - 12/8</div>
          </div>
          <a href="https://fuji-san.info" target="_blank" rel="noopener noreferrer" className="flex items-center space-x-1 bg-gray-100 px-2 py-1 rounded text-[10px] text-gray-500 hover:bg-gray-200">
             <span>Data: Fuji-san.info</span>
             <ExternalLink className="w-3 h-3" />
          </a>
        </div>
        
        {/* å¤©æ°£å°å¡ */}
        <div className="flex justify-between space-x-2 overflow-x-auto pb-2 scrollbar-hide">
          {Object.entries(weatherData).map(([date, data]) => (
            <div key={date} className="flex flex-col items-center justify-between bg-gray-50 p-2 rounded-xl min-w-[80px] h-28 border border-gray-100 shadow-sm">
              <span className="text-[10px] text-gray-500 font-medium">{date}</span>
              <div className="my-1">{data.icon}</div>
              <span className="text-xs font-bold text-gray-800">{data.temp}</span>
              <div className="flex flex-col items-center mt-1 w-full">
                <div className="text-[9px] text-gray-400 transform scale-90">å¯Œå£«è¦‹æŒ‡æ•¸</div>
                <div className="flex items-center space-x-1 bg-blue-50 px-2 py-0.5 rounded-full w-full justify-center">
                  <Eye className={`w-3 h-3 ${data.statusColor}`} />
                  <span className={`text-xs font-black tracking-tight ${data.statusColor}`}>{data.visibility}</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* è¡Œç¨‹åˆ—è¡¨ */}
      <div className="p-4 space-y-8">
        {itinerary.map((day, dayIndex) => (
          <div key={dayIndex} className="relative">
            {/* æ—¥æœŸæ¨™é¡Œ */}
            <div className={`inline-block px-4 py-1 rounded-full text-sm font-bold text-gray-700 mb-4 shadow-sm border-2 border-white ${day.color}`}>
              {day.date} {day.title}
            </div>

            {/* æ™‚é–“è»¸ç·š */}
            <div className="absolute left-8 top-12 bottom-0 w-0.5 bg-gray-200 z-0"></div>

            <div className="space-y-4 relative z-1">
              {day.items.map((item, itemIndex) => (
                <div key={item.id} className="relative">
                  {/* è¡Œè»Šæ™‚é–“æ¨™ç¤º */}
                  {item.travelTime && (
                    <div className="flex items-center ml-8 mb-2">
                       <div className="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded-full flex items-center space-x-1 border border-gray-200 shadow-sm">
                          <Car className="w-3 h-3" />
                          <span>{item.travelTime}</span>
                       </div>
                    </div>
                  )}

                  <div 
                    draggable
                    onDragStart={(e) => handleDragStart(e, dayIndex, itemIndex)}
                    onDragEnter={(e) => handleDragEnter(e, dayIndex, itemIndex)}
                    onDragOver={handleDragOver}
                    onDragEnd={handleDragEnd}
                    onDrop={handleDrop}
                    className={`
                      relative pl-14 transition-all duration-200 group
                      ${activeId === item.id ? 'transform scale-[1.02]' : ''}
                    `}
                  >
                    {/* æ‹–æ›³æ‰‹æŠŠ */}
                    <div className="absolute left-0 top-3 flex items-center justify-center w-8 h-8 cursor-move text-gray-300 hover:text-orange-400 active:text-orange-600 touch-none">
                        <GripVertical className="w-5 h-5" />
                    </div>

                    {/* æ™‚é–“è»¸è£é£¾é» */}
                    <div className={`
                      absolute left-6 top-5 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10 pointer-events-none
                      ${activeId === item.id ? 'bg-orange-400' : 'bg-gray-300'}
                    `}></div>

                    {/* å¡ç‰‡æœ¬é«” */}
                    <div 
                      onClick={() => setActiveId(item.id)}
                      className={`
                        p-4 rounded-2xl border-2 cursor-pointer
                        ${activeId === item.id ? 'bg-white border-orange-400 shadow-lg' : 'bg-white/80 border-transparent shadow-sm hover:bg-white'}
                      `}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <div className="flex items-center space-x-2 mb-1">
                            <span className={`text-sm font-bold ${activeId === item.id ? 'text-orange-500' : 'text-gray-400'}`}>
                              {item.time}
                            </span>
                            {activeId === item.id && (
                              <span className="bg-orange-100 text-orange-600 text-[10px] px-2 py-0.5 rounded-full font-bold">
                                ä¸‹ä¸€ç«™
                              </span>
                            )}
                          </div>
                          <h3 className="font-bold text-gray-800 text-lg mb-1">{item.title}</h3>
                          <p className="text-sm text-gray-500 leading-relaxed">{item.desc}</p>
                        </div>
                        <div className={`
                          p-2 rounded-full 
                          ${activeId === item.id ? 'bg-orange-100 text-orange-500' : 'bg-gray-100 text-gray-400'}
                        `}>
                          {iconMap[item.iconType] || <Camera className="w-5 h-5" />}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
              
              <div className="pl-14 pt-2">
                <button onClick={() => openAddModal(dayIndex)} className="w-full py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 hover:text-orange-500 hover:border-orange-300 hover:bg-orange-50 transition-colors flex items-center justify-center space-x-2 text-sm font-bold">
                  <Plus className="w-4 h-4" />
                  <span>æ–°å¢è¡Œç¨‹</span>
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* AI æŒ‰éˆ• (Floating Action Button) */}
      <div className="fixed bottom-36 right-4 z-40">
        <button 
          onClick={() => {
            setIsAIModalOpen(true);
            setAiResponse('');
            setAiAction(null);
          }}
          className="bg-gradient-to-tr from-purple-500 to-indigo-600 text-white p-3 rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center border-2 border-white/50 animate-bounce"
        >
          <Sparkles className="w-6 h-6 text-yellow-300" />
        </button>
      </div>

      {/* åº•éƒ¨å›ºå®šæ¬„ */}
      <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-100 p-4 rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-40">
        
        {/* Gemini AI Bar Mini View (Optional, integrated below) */}
        
        <div className="flex flex-col space-y-3">
          <div className="flex justify-between items-center px-2">
            <div>
              <div className="flex items-center space-x-1">
                 <div className="text-xs text-gray-400 font-bold mb-0.5">NEXT DESTINATION</div>
              </div>
              <div className="font-bold text-gray-800 text-lg truncate w-48">{currentItem.location}</div>
            </div>
            
            {/* AI Button - Small Version in Bar */}
            <button 
               onClick={() => {
                setIsAIModalOpen(true);
                setAiResponse('');
                setAiAction(null);
               }}
               className="flex items-center space-x-1 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg text-xs font-bold text-indigo-600 transition-colors border border-indigo-100"
            >
              <Sparkles className="w-3 h-3" />
              <span>å•å• Gemini</span>
            </button>

            <button onClick={() => setShowMapCode(!showMapCode)} className="flex items-center space-x-1 bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600 transition-colors">
              <Map className="w-3 h-3" />
              <span>Code</span>
            </button>
          </div>
          {showMapCode && (
            <div className="bg-orange-50 border-2 border-orange-200 rounded-xl p-3 text-center animate-in fade-in slide-in-from-bottom-2">
              <div className="text-xs text-orange-600 font-bold mb-1">MAP CODE (è»Šç”¨å°èˆª)</div>
              <div className="text-2xl font-mono font-black text-gray-800 tracking-widest">{currentItem.mapCode}</div>
            </div>
          )}
          <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentItem.googleQuery)}`} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center space-x-2 bg-gradient-to-r from-orange-400 to-pink-500 text-white py-3.5 rounded-xl shadow-lg hover:opacity-90 active:scale-95 transition-all">
            <Navigation className="w-5 h-5" />
            <span className="font-bold tracking-wide">Google Maps å°èˆª</span>
            <ArrowRight className="w-4 h-4 opacity-70" />
          </a>
        </div>
      </div>

      {/* æ–°å¢è¡Œç¨‹ Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
           <div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-in fade-in zoom-in duration-200">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-xl font-bold text-gray-800">æ–°å¢è¡Œç¨‹</h3>
                <button onClick={() => setIsModalOpen(false)} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-gray-400" /></button>
              </div>
              <div className="space-y-4">
                  <input type="time" value={newItemData.time} onChange={(e) => setNewItemData({...newItemData, time: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2" />
                  <input type="text" placeholder="æ¨™é¡Œ" value={newItemData.title} onChange={(e) => setNewItemData({...newItemData, title: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2" />
                  <input type="text" placeholder="åœ°é»" value={newItemData.location} onChange={(e) => setNewItemData({...newItemData, location: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2" />
                  <input type="text" placeholder="æè¿°" value={newItemData.desc} onChange={(e) => setNewItemData({...newItemData, desc: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2" />
                  <button onClick={handleAddItem} className="w-full bg-orange-500 text-white font-bold py-3 rounded-xl flex items-center justify-center space-x-2"><Save className="w-5 h-5" /><span>ç¢ºèªæ–°å¢</span></button>
              </div>
           </div>
        </div>
      )}

      {/* Gemini AI Modal */}
      {isAIModalOpen && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
           <div className="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md p-6 shadow-2xl animate-in slide-in-from-bottom-10 duration-300 flex flex-col max-h-[85vh]">
              {/* Header */}
              <div className="flex justify-between items-start mb-4">
                <div>
                  <div className="flex items-center space-x-2 text-indigo-600 mb-1">
                    <Sparkles className="w-5 h-5" />
                    <span className="font-bold text-sm tracking-wider">GEMINI æ™ºèƒ½åš®å°</span>
                  </div>
                  <h3 className="text-2xl font-bold text-gray-800">{currentItem.title}</h3>
                  <p className="text-xs text-gray-500 mt-1">ç›®å‰ä½ç½®ï¼š{currentItem.location}</p>
                </div>
                <button onClick={() => setIsAIModalOpen(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                  <X className="w-5 h-5 text-gray-600" />
                </button>
              </div>
              
              {/* Content Area */}
              <div className="flex-1 overflow-y-auto mb-4 bg-gray-50 rounded-2xl p-4 min-h-[150px]">
                 {aiLoading ? (
                   <div className="flex flex-col items-center justify-center h-full space-y-3 text-gray-400">
                     <Loader className="w-8 h-8 animate-spin text-indigo-400" />
                     <span className="text-xs">Gemini æ­£åœ¨æ€è€ƒä¸­...</span>
                   </div>
                 ) : aiResponse ? (
                   <div className="prose prose-sm text-gray-700 leading-relaxed whitespace-pre-wrap">
                     {aiResponse}
                   </div>
                 ) : (
                   <div className="flex flex-col items-center justify-center h-full text-center space-y-2 text-gray-400">
                     <MessageSquare className="w-8 h-8 opacity-20" />
                     <p className="text-sm">ä½ æƒ³çŸ¥é“é—œæ–¼é€™è£¡çš„ä»€éº¼è³‡è¨Šï¼Ÿ</p>
                   </div>
                 )}
              </div>

              {/* Action Buttons */}
              <div className="grid grid-cols-3 gap-2">
                <button 
                  onClick={() => callGemini('food')}
                  disabled={aiLoading}
                  className={`p-3 rounded-xl border-2 text-sm font-bold transition-all flex flex-col items-center space-y-1
                    ${aiAction === 'food' ? 'bg-indigo-100 border-indigo-500 text-indigo-700' : 'bg-white border-gray-100 text-gray-600 hover:border-indigo-200'}
                  `}
                >
                  <Utensils className="w-5 h-5" />
                  <span>é™„è¿‘ç¾é£Ÿ</span>
                </button>
                <button 
                  onClick={() => callGemini('photo')}
                  disabled={aiLoading}
                  className={`p-3 rounded-xl border-2 text-sm font-bold transition-all flex flex-col items-center space-y-1
                    ${aiAction === 'photo' ? 'bg-indigo-100 border-indigo-500 text-indigo-700' : 'bg-white border-gray-100 text-gray-600 hover:border-indigo-200'}
                  `}
                >
                  <Camera className="w-5 h-5" />
                  <span>æ”å½±è²¼å£«</span>
                </button>
                <button 
                  onClick={() => callGemini('info')}
                  disabled={aiLoading}
                  className={`p-3 rounded-xl border-2 text-sm font-bold transition-all flex flex-col items-center space-y-1
                    ${aiAction === 'info' ? 'bg-indigo-100 border-indigo-500 text-indigo-700' : 'bg-white border-gray-100 text-gray-600 hover:border-indigo-200'}
                  `}
                >
                  <Sparkles className="w-5 h-5" />
                  <span>æ™¯é»ç§˜è¾›</span>
                </button>
              </div>
           </div>
        </div>
      )}

      {/* èƒŒæ™¯è£é£¾ */}
      <div className="fixed top-20 right-[-20px] text-yellow-300 opacity-20 pointer-events-none"><Sun className="w-32 h-32" /></div>
    </div>
  );
};

export default FujiTripApp;