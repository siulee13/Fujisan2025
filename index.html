<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯Œå£«å±±è¿½æ¥“ä¹‹æ—…</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #fff7ed; /* orange-50 */
        }
        .font-kosugi {
            font-family: "Kosugi Maru", sans-serif;
        }
        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* å‹•ç•«é¡ */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        /* Loading é®ç½© */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body class="pb-44 text-gray-800">

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <i class="fa-solid fa-cloud text-orange-400 text-5xl animate-bounce mb-4"></i>
        <p id="loading-text" class="text-gray-500 font-bold">æ­£åœ¨è®€å–è¡Œç¨‹...</p>
    </div>

    <div class="max-w-md mx-auto shadow-2xl min-h-screen bg-orange-50 relative overflow-hidden">
        
        <!-- Header -->
        <div class="bg-white p-4 rounded-b-3xl shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 tracking-wider font-kosugi">
                        å¯Œå£«å±±è¿½æ¥“ä¹‹æ—… ğŸ
                    </h1>
                    <div class="text-xs text-gray-400">12/5 - 12/8</div>
                </div>
                <a href="https://fuji-san.info" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-1 bg-gray-100 px-2 py-1 rounded text-[10px] text-gray-500 hover:bg-gray-200">
                    <span>Data: Fuji-san.info</span>
                    <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i>
                </a>
            </div>

            <!-- Weather Cards Container -->
            <div id="weather-container" class="flex justify-between space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                <!-- Weather Items will be injected here -->
            </div>
        </div>

        <!-- Itinerary List -->
        <div id="itinerary-list" class="p-4 space-y-8">
            <!-- Itinerary Days and Items will be injected here -->
        </div>

        <!-- AI Floating Button -->
        <div class="fixed bottom-36 right-4 z-40 max-w-md mx-auto w-full pointer-events-none flex justify-end pr-4">
            <button onclick="window.openAIModal()" class="pointer-events-auto bg-gradient-to-tr from-purple-500 to-indigo-600 text-white p-3 rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center border-2 border-white/50 animate-bounce">
                <i class="fa-solid fa-wand-magic-sparkles text-yellow-300 text-xl"></i>
            </button>
        </div>

        <!-- Bottom Fixed Bar -->
        <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-100 p-4 rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-40">
            <div class="flex flex-col space-y-3">
                <div class="flex justify-between items-center px-2 gap-2">
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-400 font-bold mb-0.5">NEXT DESTINATION</div>
                        <div id="current-location" class="font-bold text-gray-800 text-lg truncate">---</div>
                    </div>
                    
                    <div class="flex space-x-2 shrink-0">
                        <button onclick="window.openAIModal()" class="flex items-center space-x-1 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg text-xs font-bold text-indigo-600 transition-colors border border-indigo-100">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            <span class="hidden sm:inline">Gemini</span>
                        </button>

                        <button onclick="window.openMapCodeSite()" class="flex items-center space-x-1 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg text-xs font-bold text-blue-600 transition-colors border border-blue-100">
                            <i class="fa-solid fa-globe"></i>
                            <span>æœå°‹</span>
                        </button>

                        <button onclick="window.toggleMapCode()" class="flex items-center space-x-1 bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600 transition-colors">
                            <i class="fa-solid fa-map"></i>
                            <span>Code</span>
                        </button>
                    </div>
                </div>

                <!-- Map Code Display -->
                <div id="map-code-display" class="hidden bg-orange-50 border-2 border-orange-200 rounded-xl p-3 text-center fade-in">
                    <div class="text-xs text-orange-600 font-bold mb-1">MAP CODE (è»Šç”¨å°èˆª)</div>
                    <div id="current-map-code" class="text-2xl font-mono font-black text-gray-800 tracking-widest">---</div>
                </div>

                <a id="google-maps-link" href="#" target="_blank" class="flex items-center justify-center space-x-2 bg-gradient-to-r from-orange-400 to-pink-500 text-white py-3.5 rounded-xl shadow-lg hover:opacity-90 active:scale-95 transition-all">
                    <i class="fa-solid fa-location-arrow"></i>
                    <span class="font-bold tracking-wide">Google Maps å°èˆª</span>
                    <i class="fa-solid fa-arrow-right opacity-70"></i>
                </a>
            </div>
        </div>

        <!-- Add Item Modal -->
        <div id="add-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl slide-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="add-modal-title" class="text-xl font-bold text-gray-800">æ–°å¢è¡Œç¨‹</h3>
                    <button onclick="window.closeAddModal()" class="p-1 hover:bg-gray-100 rounded-full">
                        <i class="fa-solid fa-xmark text-xl text-gray-400"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <input type="time" id="new-item-time" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-200">
                    <input type="text" id="new-item-title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-200">
                    <input type="text" id="new-item-location" placeholder="åœ°é» (Google Maps æœå°‹ç”¨)" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-200">
                    <input type="text" id="new-item-desc" placeholder="æè¿°" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-200">
                    
                    <!-- Map Code Input -->
                    <input type="text" id="new-item-mapcode" placeholder="Map Code (é¸å¡«)" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-gray-800 font-mono focus:outline-none focus:ring-2 focus:ring-orange-200">
                    
                    <button onclick="window.confirmAddItem()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center space-x-2 transition-colors">
                        <i class="fa-solid fa-floppy-disk"></i>
                        <span>ç¢ºèªæ–°å¢</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Modal -->
        <div id="ai-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md p-6 shadow-2xl slide-up flex flex-col max-h-[85vh]">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center space-x-2 text-indigo-600 mb-1">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            <span class="font-bold text-sm tracking-wider">GEMINI æ™ºèƒ½åš®å°</span>
                        </div>
                        <h3 id="ai-modal-title" class="text-2xl font-bold text-gray-800">---</h3>
                        <p id="ai-modal-subtitle" class="text-xs text-gray-500 mt-1">---</p>
                    </div>
                    <button onclick="window.closeAIModal()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                        <i class="fa-solid fa-xmark text-gray-600"></i>
                    </button>
                </div>

                <div id="ai-content-area" class="flex-1 overflow-y-auto mb-4 bg-gray-50 rounded-2xl p-4 min-h-[150px]">
                    <div class="flex flex-col items-center justify-center h-full text-center space-y-2 text-gray-400">
                        <i class="fa-regular fa-message text-3xl opacity-20"></i>
                        <p class="text-sm">ä½ æƒ³çŸ¥é“é—œæ–¼é€™è£¡çš„ä»€éº¼è³‡è¨Šï¼Ÿ</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <button onclick="window.callGemini('food')" class="p-3 rounded-xl border-2 bg-white border-gray-100 text-gray-600 hover:border-indigo-200 text-sm font-bold transition-all flex flex-col items-center space-y-1">
                        <i class="fa-solid fa-utensils"></i>
                        <span>é™„è¿‘ç¾é£Ÿ</span>
                    </button>
                    <button onclick="window.callGemini('photo')" class="p-3 rounded-xl border-2 bg-white border-gray-100 text-gray-600 hover:border-indigo-200 text-sm font-bold transition-all flex flex-col items-center space-y-1">
                        <i class="fa-solid fa-camera"></i>
                        <span>æ”å½±è²¼å£«</span>
                    </button>
                    <button onclick="window.callGemini('info')" class="p-3 rounded-xl border-2 bg-white border-gray-100 text-gray-600 hover:border-indigo-200 text-sm font-bold transition-all flex flex-col items-center space-y-1">
                        <i class="fa-solid fa-lightbulb"></i>
                        <span>æ™¯é»ç§˜è¾›</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Background Decoration -->
        <div class="fixed top-20 right-[-20px] text-yellow-300 opacity-20 pointer-events-none">
            <i class="fa-solid fa-sun text-9xl"></i>
        </div>

    </div>

    <!-- Firebase SDK (ES Module) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // 1. Firebase åˆå§‹åŒ– (åŒ…å«è‡ªå‹•é™ç´š LocalStorage é‚è¼¯)
        let db, auth, docRef;
        let useLocalStorage = false;

        try {
            // æª¢æŸ¥æ˜¯å¦åœ¨ Firebase ç’°å¢ƒä¸­ (GitHub Pages éƒ¨ç½²æ™‚ __firebase_config æœƒä¸å­˜åœ¨)
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
                docRef = doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', 'main_plan');
            } else {
                throw new Error("No Firebase Config found");
            }
        } catch (e) {
            console.warn("Running in Local Mode (Offline/GitHub Pages):", e.message);
            useLocalStorage = true;
        }

        // 2. æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ (State)
        let state = {
            itinerary: [], 
            activeId: 'd1-1',
            showMapCode: false,
            addModalTargetIndex: 0
        };

        // é è¨­è¡Œç¨‹ (å«å…§ç½® Map Code)
        const initialDefaultItinerary = [
            {
                day: "Day 0", date: "12/5 (äº”)", title: "å‡ºç™¼èˆ‡æŠµé”", color: "bg-orange-100",
                items: [
                    { id: 'd0-1', time: '20:20', title: 'é¦™æ¸¯èµ·é£›', desc: 'UO628 HKG -> HND', location: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´', mapCode: '-', googleQuery: 'Hong Kong International Airport', iconType: 'Navigation' },
                    { id: 'd0-2', time: '00:32', title: 'æŠµé”ç¾½ç”° & å…¥ä½', desc: 'T3 ç›´çµï¼Œé ˜è¡Œæå¾Œç›´æ¥ç¡è¦º', location: 'çš‡å®¶å…¬åœ’é…’åº— æ±äº¬ç¾½ç”°', mapCode: '167 327 714*32', googleQuery: 'The Royal Park Hotel Tokyo Haneda Airport Terminal 3', iconType: 'BedDouble' }
                ]
            },
            {
                day: "Day 1", date: "12/6 (å…­)", title: "æ²³å£æ¹–ç¶“å…¸å·¡ç¦®", color: "bg-blue-100",
                items: [
                    { id: 'd1-1', time: '09:30', title: 'ç¾½ç”°å–è»Šå‡ºç™¼', desc: 'è¨˜å¾—æª¢æŸ¥ ETC å¡èˆ‡é›ªèƒã€‚', location: 'ç¾½ç”°æ©Ÿå ´ç§Ÿè»Šé»', mapCode: '167 327 714*32', googleQuery: 'Haneda Airport Rental Car', iconType: 'Car' },
                    { id: 'd1-2', time: '12:30', title: 'åˆé¤ï¼šHoutou Fudo', desc: 'å¿…åƒé›²æœµé€ å‹é¤ºé£¥éºµ (æ±æ‹è·¯åº—)', location: 'ã»ã†ã¨ã†ä¸å‹• æ±æ‹è·¯åº—', mapCode: '161 240 502*12', googleQuery: 'Houtou Fudo Higashikoiji', iconType: 'Utensils', travelTime: 'ç´„ 1å°æ™‚50åˆ†' },
                    { id: 'd1-3', time: '14:00', title: 'å¤§çŸ³å…¬åœ’', desc: 'æ²³å£æ¹–ç•”çœ‹å¯Œå£«å±±å…¨æ™¯ï¼Œçµ•ç¾ï¼', location: 'å¤§çŸ³å…¬åœ’', mapCode: '161 303 629*28', googleQuery: 'Oishi Park Yamanashi', iconType: 'Camera', travelTime: 'ç´„ 20åˆ†' },
                    { id: 'd1-4', time: '15:30', title: 'ç´…è‘‰è¿´å»Š', desc: 'å°‹æ‰¾æœ€å¾Œçš„ç´…è‘‰åœ°æ¯¯ (ä¹…ä¿ç”°ä¸€ç«¹ç¾è¡“é¤¨æ—)', location: 'å¯Œå£«æ²³å£æ¹–ç´…è‘‰è¿´å»Š', mapCode: '161 303 346*55', googleQuery: 'Momiji Corridor Kawaguchiko', iconType: 'Camera', travelTime: 'ç´„ 5åˆ†' },
                    { id: 'd1-5', time: '16:30', title: 'å…¥ä½ La Vista', desc: 'äº«å—ç§äººé¢¨å‘‚èˆ‡å…è²»å®µå¤œæ‹‰éºµ', location: 'La Vista Fuji Kawaguchiko', mapCode: '161 301 224*88', googleQuery: 'La Vista Fuji Kawaguchiko', iconType: 'BedDouble', travelTime: 'ç´„ 8åˆ†' }
                ]
            },
            {
                day: "Day 2", date: "12/7 (æ—¥)", title: "çµ•æ™¯ç¥ç¤¾èˆ‡é‘½çŸ³å¯Œå£«", color: "bg-yellow-100",
                items: [
                    { id: 'd2-1', time: '09:00', title: 'æ–°å€‰å±±æ·ºé–“å…¬åœ’', desc: 'çˆ¬æ¨“æ¢¯ï¼äº”é‡å¡” + å¯Œå£«å±±ç¶“å…¸ç…§', location: 'æ–°å€‰å±±æ·ºé–“å…¬åœ’', mapCode: '161 244 562*52', googleQuery: 'Chureito Pagoda', iconType: 'Camera', travelTime: 'ç´„ 25åˆ†' },
                    { id: 'd2-2', time: '12:30', title: 'åˆé¤ï¼šå±±éº“åœ’', desc: 'é«”é©—åœçˆè£ç‚­ç«ç‡’çƒ¤', location: 'å±±éº“åœ’ (Sanrokuen)', mapCode: '161 214 058*60', googleQuery: 'Sanrokuen Kawaguchiko', iconType: 'Utensils', travelTime: 'ç´„ 15åˆ†' },
                    { id: 'd2-3', time: '15:30', title: 'å±±ä¸­æ¹–èŠ±ä¹‹éƒ½å…¬åœ’', desc: 'å†¬å­£é»ç‡ˆ + æ©Ÿæœƒçœ‹é‘½çŸ³å¯Œå£«', location: 'å±±ä¸­æ¹–èŠ±ä¹‹éƒ½å…¬åœ’', mapCode: '161 046 805*44', googleQuery: 'Yamanakako Hananomiyako Park', iconType: 'Camera', travelTime: 'ç´„ 25åˆ†' },
                    { id: 'd2-4', time: '18:00', title: 'å…¥ä½ New Century', desc: 'æˆ¿é–“ç›´æ¥çœ‹æ¹–é¢é€†å¯Œå£«', location: 'Hotel New Century', mapCode: '161 302 188*41', googleQuery: 'Hotel New Century Kawaguchiko', iconType: 'BedDouble', travelTime: 'ç´„ 25åˆ†' }
                ]
            },
            {
                day: "Day 3", date: "12/8 (ä¸€)", title: "æœéœ§é«˜åŸèˆ‡å›ç¨‹", color: "bg-green-100",
                items: [
                    { id: 'd3-1', time: '09:30', title: 'å‡ºç™¼å¾€è¥¿éº“', desc: 'é›¢é–‹æ²³å£æ¹–ï¼Œæ²¿åœ‹é“139è™Ÿå¾€è¥¿', location: 'å¾€æœéœ§é«˜åŸæ–¹å‘', mapCode: '-', googleQuery: 'National Route 139', iconType: 'Car' },
                    { id: 'd3-2', time: '10:30', title: 'æœéœ§é«˜åŸ (é¦¬é£¼é‡ç‰§å ´)', desc: 'ç„¡é®æ“‹çš„å·¨å¤§å¯Œå£«å±±ï¼ç›ªé¦éŸ†æ‹ç…§ã€å–ç‰›å¥¶', location: 'é¦¬é£¼é‡ç‰§å ´ (Makaino Farm)', mapCode: '72 233 426*77', googleQuery: 'Makaino Farm', iconType: 'Camera', travelTime: 'ç´„ 45åˆ†' },
                    { id: 'd3-3', time: '12:00', title: 'åˆé¤ï¼šé“ä¹‹ç«™ æœéœ§', desc: 'ç•¶ç¬¬ç¾é£Ÿã€ç‰›å¥¶éœœæ·‡æ·‹', location: 'Roadside Station Asagiri', mapCode: '72 263 777*25', googleQuery: 'Roadside Station Asagiri', iconType: 'Utensils', travelTime: 'ç´„ 5åˆ†' },
                    { id: 'd3-4', time: '14:30', title: 'é…’é…’äº• Outlet', desc: 'æœ€å¾Œè¡åˆºï¼(ç¶“æ–°æ±å/åœˆå¤®é“å‰å¾€)', location: 'Shisui Premium Outlets', mapCode: '27 573 846*77', googleQuery: 'Shisui Premium Outlets', iconType: 'Coffee', travelTime: 'ç´„ 2å°æ™‚45åˆ†' },
                    { id: 'd3-5', time: '17:30', title: 'æˆç”°æ©Ÿå ´é‚„è»Š', desc: 'åŠ æ»¿æ²¹ï¼Œæª¢æŸ¥ç‰©å“', location: 'æˆç”°æ©Ÿå ´é™„è¿‘ç§Ÿè»Š', mapCode: '137 646 088*55', googleQuery: 'Narita Airport Rental Car Return', iconType: 'Car', travelTime: 'ç´„ 15åˆ†' },
                    { id: 'd3-6', time: '20:05', title: 'é£›æ©Ÿèµ·é£›', desc: 'UO651 NRT -> HKG', location: 'æˆç”°åœ‹éš›æ©Ÿå ´', mapCode: '-', googleQuery: 'Narita International Airport', iconType: 'Navigation' }
                ]
            }
        ];

        // 3. å…¨åŸŸè®Šæ•¸èˆ‡ API
        const geminiApiKey = ""; // è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Gemini API Key
        let dragSource = null;

        const weatherData = {
            '12/5': { icon: 'fa-cloud', temp: '8Â°C', desc: 'å¤§è‡´å¤šé›²', visibility: '9/10', color: 'text-blue-600', iconColor: 'text-gray-400' },
            '12/6': { icon: 'fa-sun', temp: '-2~9Â°C', desc: 'æ™´æ™‚å¤šé›²', visibility: '10/10', color: 'text-orange-600', iconColor: 'text-orange-500' },
            '12/7': { icon: 'fa-sun', temp: '-3~8Â°C', desc: 'è¶…ç´šæ™´æœ—', visibility: '10/10', color: 'text-orange-600', iconColor: 'text-orange-500' },
            '12/8': { icon: 'fa-sun', temp: '-4~10Â°C', desc: 'è¬é‡Œç„¡é›²', visibility: '10/10', color: 'text-orange-600', iconColor: 'text-orange-500' },
        };

        const iconMap = {
            'Navigation': 'fa-location-arrow',
            'BedDouble': 'fa-bed',
            'Car': 'fa-car',
            'Utensils': 'fa-utensils',
            'Camera': 'fa-camera',
            'Coffee': 'fa-mug-hot',
            'Map': 'fa-map'
        };

        // 4. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ (initApp)
        async function initApp() {
            if (useLocalStorage) {
                // === LocalStorage æ¨¡å¼ (GitHub Pages) ===
                document.getElementById('loading-text').innerText = "è®€å–æœ¬åœ°è¡Œç¨‹...";
                
                // å˜—è©¦è®€å–æœ¬åœ°è³‡æ–™
                const savedData = localStorage.getItem('fuji_trip_data');
                if (savedData) {
                    try {
                        state.itinerary = JSON.parse(savedData);
                    } catch(e) {
                        console.error("Parse Error:", e);
                        state.itinerary = initialDefaultItinerary;
                    }
                } else {
                    state.itinerary = initialDefaultItinerary;
                }
                
                finishLoading();
            } else {
                // === Firebase æ¨¡å¼ (é è¦½ç’°å¢ƒ) ===
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onSnapshot(docRef, (docSnapshot) => {
                        if (docSnapshot.exists()) {
                            state.itinerary = docSnapshot.data().data;
                        } else {
                            state.itinerary = initialDefaultItinerary;
                            saveData(); 
                        }
                        finishLoading();
                    }, (error) => {
                        console.error("Sync Error:", error);
                        // å‡ºéŒ¯æ™‚é™ç´šç‚ºæœ¬åœ°è³‡æ–™
                        state.itinerary = initialDefaultItinerary;
                        finishLoading();
                    });

                } catch (err) {
                    console.error("Auth Error:", err);
                    state.itinerary = initialDefaultItinerary;
                    finishLoading();
                }
            }
            renderWeather();
        }

        // å®Œæˆè®€å–å¾Œçš„å‹•ä½œ
        function finishLoading() {
            renderItinerary();
            updateBottomBar();
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // å„²å­˜è³‡æ–™ (è‡ªå‹•åˆ¤æ–·æ¨¡å¼)
        async function saveData() {
            if (useLocalStorage) {
                // å„²å­˜åˆ° LocalStorage
                localStorage.setItem('fuji_trip_data', JSON.stringify(state.itinerary));
            } else {
                // å„²å­˜åˆ° Firebase
                try {
                    await setDoc(docRef, { data: state.itinerary });
                } catch (e) {
                    console.error("Save Error:", e);
                }
            }
        }

        // 5. æ¸²æŸ“å‡½å¼
        function renderWeather() {
            const container = document.getElementById('weather-container');
            let html = '';
            for (const [date, data] of Object.entries(weatherData)) {
                html += `
                    <div class="flex flex-col items-center justify-between bg-gray-50 p-2 rounded-xl min-w-[80px] h-28 border border-gray-100 shadow-sm">
                        <span class="text-[10px] text-gray-500 font-medium">${date}</span>
                        <div class="my-1"><i class="fa-solid ${data.icon} ${data.iconColor} text-xl"></i></div>
                        <span class="text-xs font-bold text-gray-800">${data.temp}</span>
                        <div class="flex flex-col items-center mt-1 w-full">
                            <div class="text-[9px] text-gray-400 transform scale-90">å¯Œå£«è¦‹æŒ‡æ•¸</div>
                            <div class="flex items-center space-x-1 bg-blue-50 px-2 py-0.5 rounded-full w-full justify-center">
                                <i class="fa-solid fa-eye ${data.color} text-[10px]"></i>
                                <span class="text-xs font-black tracking-tight ${data.color}">${data.visibility}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-list');
            container.innerHTML = '';

            state.itinerary.forEach((day, dayIndex) => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'relative';

                let itemsHtml = '';
                day.items.forEach((item, itemIndex) => {
                    const isActive = state.activeId === item.id;
                    const activeScale = isActive ? 'transform scale-[1.02]' : '';
                    const activeCardClass = isActive ? 'bg-white border-orange-400 shadow-lg' : 'bg-white/80 border-transparent shadow-sm hover:bg-white';
                    const activeTimeColor = isActive ? 'text-orange-500' : 'text-gray-400';
                    const activeIconBg = isActive ? 'bg-orange-100 text-orange-500' : 'bg-gray-100 text-gray-400';
                    const activeDot = isActive ? 'bg-orange-400' : 'bg-gray-300';
                    const nextTag = isActive ? `<span class="bg-orange-100 text-orange-600 text-[10px] px-2 py-0.5 rounded-full font-bold">ä¸‹ä¸€ç«™</span>` : '';
                    const travelTimeTag = item.travelTime ? `
                        <div class="flex items-center ml-8 mb-2">
                           <div class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded-full flex items-center space-x-1 border border-gray-200 shadow-sm">
                              <i class="fa-solid fa-car"></i>
                              <span>${item.travelTime}</span>
                           </div>
                        </div>` : '';
                    
                    const faIcon = iconMap[item.iconType] || 'fa-camera';

                    itemsHtml += `
                        <div class="relative">
                            ${travelTimeTag}
                            <div 
                                class="relative pl-14 transition-all duration-200 group ${activeScale}"
                                draggable="true"
                                ondragstart="window.handleDragStart(event, ${dayIndex}, ${itemIndex})"
                                ondragover="window.handleDragOver(event)"
                                ondrop="window.handleDrop(event, ${dayIndex}, ${itemIndex})"
                                ondragend="window.handleDragEnd(event)"
                            >
                                <div class="absolute left-0 top-3 flex items-center justify-center w-8 h-8 cursor-move text-gray-300 hover:text-orange-400 active:text-orange-600 touch-none">
                                    <i class="fa-solid fa-grip-vertical"></i>
                                </div>
                                <div class="absolute left-6 top-5 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10 pointer-events-none ${activeDot}"></div>
                                <div onclick="window.setActiveItem('${item.id}')" class="p-4 rounded-2xl border-2 cursor-pointer ${activeCardClass}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="text-sm font-bold ${activeTimeColor}">${item.time}</span>
                                                ${nextTag}
                                            </div>
                                            <h3 class="font-bold text-gray-800 text-lg mb-1">${item.title}</h3>
                                            <p class="text-sm text-gray-500 leading-relaxed">${item.desc}</p>
                                        </div>
                                        <div class="p-2 rounded-full ${activeIconBg} w-9 h-9 flex items-center justify-center">
                                            <i class="fa-solid ${faIcon}"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="h-4"></div>
                    `;
                });

                dayDiv.innerHTML = `
                    <div class="inline-block px-4 py-1 rounded-full text-sm font-bold text-gray-700 mb-4 shadow-sm border-2 border-white ${day.color}">
                        ${day.date} ${day.title}
                    </div>
                    <div class="absolute left-8 top-12 bottom-0 w-0.5 bg-gray-200 z-0"></div>
                    <div class="space-y-0 relative z-1">
                        ${itemsHtml}
                        <div class="pl-14 pt-2">
                            <button onclick="window.openAddModal(${dayIndex})" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 hover:text-orange-500 hover:border-orange-300 hover:bg-orange-50 transition-colors flex items-center justify-center space-x-2 text-sm font-bold">
                                <i class="fa-solid fa-plus"></i>
                                <span>æ–°å¢è¡Œç¨‹</span>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(dayDiv);
            });
        }

        function getCurrentItem() {
            for (const day of state.itinerary) {
                const found = day.items.find(item => item.id === state.activeId);
                if (found) return found;
            }
            if(state.itinerary.length > 0 && state.itinerary[0].items.length > 0) 
                return state.itinerary[0].items[0];
            return { location: 'è«‹é¸æ“‡è¡Œç¨‹', mapCode: '-', googleQuery: '', title: 'è¡Œç¨‹è¡¨' };
        }

        function updateBottomBar() {
            const item = getCurrentItem();
            document.getElementById('current-location').innerText = item.location;
            
            // æ›´æ–° Map Code é¡¯ç¤ºæ–‡å­—
            const mapCodeDisplay = document.getElementById('current-map-code');
            mapCodeDisplay.innerText = item.mapCode || '---';
            
            document.getElementById('google-maps-link').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.googleQuery)}`;
            
            // è™•ç†é¡¯ç¤ºç‹€æ…‹
            const mapCodeContainer = document.getElementById('map-code-display');
            if (state.showMapCode) {
                mapCodeContainer.classList.remove('hidden');
            } else {
                mapCodeContainer.classList.add('hidden');
            }
        }

        // 6. äº’å‹•èˆ‡è¦–çª—å‡½å¼
        window.setActiveItem = function(id) {
            state.activeId = id;
            renderItinerary();
            updateBottomBar();
        }

        // Toggle Map Code Visibility
        window.toggleMapCode = function() {
            state.showMapCode = !state.showMapCode;
            updateBottomBar();
        }

        // Open Map Code Site
        window.openMapCodeSite = function() {
            window.open('https://mapcodejapan.com/zh-Hant/', '_blank');
        }

        // Drag & Drop
        window.handleDragStart = function(e, dayIndex, itemIndex) {
            dragSource = { dayIndex, itemIndex };
            e.dataTransfer.effectAllowed = "move";
            e.target.classList.add('dragging');
        }
        window.handleDragOver = function(e) { e.preventDefault(); }
        window.handleDragEnd = function(e) { e.target.classList.remove('dragging'); }
        window.handleDrop = function(e, destDayIndex, destItemIndex) {
            e.preventDefault();
            if (!dragSource) return;
            const sourceDay = state.itinerary[dragSource.dayIndex];
            const destDay = state.itinerary[destDayIndex];
            const [movedItem] = sourceDay.items.splice(dragSource.itemIndex, 1);
            destDay.items.splice(destItemIndex, 0, movedItem);
            saveData(); 
            dragSource = null;
        }

        // Add Modal
        window.openAddModal = function(dayIndex) {
            state.addModalTargetIndex = dayIndex;
            document.getElementById('new-item-time').value = '12:00';
            document.getElementById('new-item-title').value = '';
            document.getElementById('new-item-location').value = '';
            document.getElementById('new-item-desc').value = '';
            // Reset Map Code input
            document.getElementById('new-item-mapcode').value = '';
            
            const dayTitle = state.itinerary[dayIndex].date;
            document.getElementById('add-modal-title').innerText = `æ–°å¢è¡Œç¨‹è‡³ ${dayTitle}`;
            document.getElementById('add-modal').classList.remove('hidden');
        }
        window.closeAddModal = function() {
            document.getElementById('add-modal').classList.add('hidden');
        }
        window.confirmAddItem = function() {
            const time = document.getElementById('new-item-time').value;
            const title = document.getElementById('new-item-title').value;
            const location = document.getElementById('new-item-location').value;
            const desc = document.getElementById('new-item-desc').value;
            // Get Map Code Value
            const mapCode = document.getElementById('new-item-mapcode').value || '---';
            
            if (!title) { alert('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }
            
            const newItem = {
                id: `new-${Date.now()}`, time, title, desc, location,
                mapCode: mapCode, // Save custom map code
                googleQuery: location, iconType: 'Camera'
            };
            state.itinerary[state.addModalTargetIndex].items.push(newItem);
            
            saveData();
            window.closeAddModal();
        }

        // AI Modal
        window.openAIModal = function() {
            const item = getCurrentItem();
            document.getElementById('ai-modal-title').innerText = item.title;
            document.getElementById('ai-modal-subtitle').innerText = `ç›®å‰ä½ç½®ï¼š${item.location}`;
            document.getElementById('ai-content-area').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-2 text-gray-400">
                    <i class="fa-regular fa-message text-3xl opacity-20"></i>
                    <p class="text-sm">ä½ æƒ³çŸ¥é“é—œæ–¼é€™è£¡çš„ä»€éº¼è³‡è¨Šï¼Ÿ</p>
                </div>
            `;
            document.getElementById('ai-modal').classList.remove('hidden');
        }
        window.closeAIModal = function() {
            document.getElementById('ai-modal').classList.add('hidden');
        }
        window.callGemini = async function(type) {
            const contentArea = document.getElementById('ai-content-area');
            const item = getCurrentItem();
            contentArea.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full space-y-3 text-gray-400">
                    <i class="fa-solid fa-spinner fa-spin text-2xl text-indigo-400"></i>
                    <span class="text-xs">Gemini æ­£åœ¨æ€è€ƒä¸­...</span>
                </div>
            `;
            let prompt = `ä½ æ˜¯ä¸€ä½ç†Ÿæ‚‰æ—¥æœ¬å¯Œå£«å±±åœ°å€çš„ç¹é«”ä¸­æ–‡(é¦™æ¸¯é¢¨æ ¼)å°éŠã€‚
            ä½¿ç”¨è€…ç›®å‰ä½æ–¼ï¼š${item.location} (${item.title})ã€‚
            è«‹ç°¡çŸ­ã€æœ‰è¶£åœ°å›ç­”ä»¥ä¸‹å•é¡Œï¼š`;
            switch (type) {
                case 'food': prompt += ` è«‹æ¨è–¦ 2-3 é–“æ­¤åœ°é»é™„è¿‘çš„å¿…åƒç¾é£Ÿæˆ–é¤å»³ï¼Œä¸¦èªªæ˜ç‰¹è‰²ã€‚`; break;
                case 'photo': prompt += ` è«‹æä¾›æ­¤åœ°é»çš„æœ€ä½³æ”å½±å»ºè­°ï¼ˆä¾‹å¦‚ï¼šæ‹æ”è§’åº¦ã€æœ€ä½³æ™‚é–“ã€æ˜¯å¦èƒ½çœ‹åˆ°é€†å¯Œå£«æˆ–é‘½çŸ³å¯Œå£«ï¼‰ã€‚`; break;
                case 'info': prompt += ` è«‹å‘Šè¨´æˆ‘é—œæ–¼æ­¤åœ°é»çš„ä¸€å€‹å†·çŸ¥è­˜ã€æ­·å²æ•…äº‹æˆ–éš±è—ç©æ³•ã€‚`; break;
                default: prompt += ` çµ¦æˆ‘ä¸€äº›é—œæ–¼é€™å€‹åœ°æ–¹çš„å¯¦ç”¨æ—…éŠå»ºè­°ã€‚`;
            }
            try {
                if (!geminiApiKey) throw new Error("API Key æœªè¨­å®š");
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    }
                );
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼ŒGemini æš«æ™‚ç„¡æ³•é€£ç·šã€‚";
                const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                contentArea.innerHTML = `<div class="prose prose-sm text-gray-700 leading-relaxed">${formattedText}</div>`;
            } catch (error) {
                console.error(error);
                let msg = "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚";
                if (error.message === "API Key æœªè¨­å®š") msg = "è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ‚¨çš„ Gemini API Keyã€‚";
                contentArea.innerHTML = `<div class="text-red-500 text-center text-sm p-4">${msg}</div>`;
            }
        }

        // å•Ÿå‹• App
        initApp();

    </script>
</body>
</html>